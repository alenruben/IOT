// Import the MySQL library
const mysql = require('mysql2');

// Create a database connection
const connection = mysql.createConnection({
    host: 'localhost',
    user: 'root',
    password: '',
    database: 'iotalen'
});

// Connect to the database
connection.connect((err) => {
    if (err) {
        console.error('Gagal terhubung ke database:', err.message);
        return;
    }
    console.log('Berhasil terhubung ke database');
});

// Function to execute a query and return results as an array
function query(sql) {
    return new Promise((resolve, reject) => {
        connection.query(sql, (err, results) => {
            if (err) {
                console.error('Query error:', err.message);
                reject(err);
            } else {
                resolve(results);
            }
        });
    });
}

// Retrieve the latest data from the sensor table
async function getLatestSensorData() {
    try {
        const sql = "SELECT asap, pir, led_merah, led_hijau, lcd FROM sensor ORDER BY date DESC LIMIT 1";
        const results = await query(sql);
        return results[0] || null; // Return the first result or null if no data
    } catch (err) {
        console.error('Error fetching latest sensor data:', err.message);
        return null;
    }
}

// Retrieve the username from the users table
async function getNama() {
    try {
        const sql = "SELECT username FROM users";
        const results = await query(sql);
        return results.map(row => row.username); // Return an array of usernames
    } catch (err) {
        console.error('Error fetching usernames:', err.message);
        return [];
    }
}

// Example usage
(async () => {
    const latestData = await getLatestSensorData();
    console.log('Latest Sensor Data:', latestData);

    const usernames = await getNama();
    console.log('Usernames:', usernames);

    // Close the database connection
    connection.end();
})();
